<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <title>Minimal PiP Monitor - Stable</title>
    <style>
        body { 
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif; 
            background: #f4f4f9; 
            color: #333; 
            display: flex; 
            justify-content: center; 
            align-items: center; 
            height: 100vh; 
            margin: 0; 
        }
        .card { 
            background: white; 
            padding: 30px; 
            border-radius: 16px; 
            text-align: center; 
            box-shadow: 0 10px 25px rgba(0,0,0,0.05); 
            width: 280px; 
        }
        h3 { margin-top: 0; font-weight: 600; color: #1d1d1f; }
        button { 
            width: 100%; 
            padding: 12px; 
            margin-top: 10px; 
            border-radius: 8px; 
            border: none; 
            cursor: pointer; 
            font-weight: 600; 
            transition: all 0.2s; 
        }
        .btn-capture { background: #000; color: #fff; }
        .btn-capture:hover { opacity: 0.8; }
        .btn-pip { background: #0071e3; color: white; display: none; }
        
        #status { 
            font-size: 13px; 
            margin-top: 15px; 
            color: #666; 
            padding: 8px;
            background: #eee;
            border-radius: 4px;
            font-family: monospace;
        }
        
        /* The Alert Box - This will be moved into the PiP window */
        #alert-box {
            width: 100%;
            height: 100%;
            background: #ffffff;
            display: flex;
            align-items: center;
            justify-content: center;
            transition: background 0.2s ease;
        }
        .trigger-active { 
            background: #ff3b30 !important; /* Apple-style Red */
        }
    </style>
</head>
<body>

<div class="card">
    <h3>PiP Monitor</h3>
    <button class="btn-capture" onclick="startCapture()">1. Select Window</button>
    <div id="status">Waiting for input...</div>
    <button class="btn-pip" id="pipBtn" onclick="openPip()">2. Pop Out (PiP)</button>

    <div id="alert-box"></div>
</div>

<script>
    let sourceStream;
    let pipWindow = null;
    let varianceHistory = []; // Stores samples to prevent flickering
    const MAX_HISTORY = 3;   // Number of seconds to average
    
    let canvas = document.createElement("canvas");
    let ctx = canvas.getContext("2d", {willReadFrequently: true});
    const alertBox = document.getElementById('alert-box');
    const pipBtn = document.getElementById('pipBtn');
    const statusText = document.getElementById('status');

    canvas.width = 100;
    canvas.height = 100;

    async function startCapture() {
        try {
            sourceStream = await navigator.mediaDevices.getDisplayMedia({
                video: { 
                    displaySurface: "window", 
                    frameRate: 1 
                },
                audio: false
            });
            
            statusText.innerText = "Connected - Analyzing...";
            pipBtn.style.display = "block";
            startAnalysis();
        } catch (err) { 
            console.error("Error:", err);
            statusText.innerText = "Capture Cancelled";
        }
    }

    async function openPip() {
        if (!window.documentPictureInPicture) {
            alert("Your browser does not support Document Picture-in-Picture.");
            return;
        }

        pipWindow = await window.documentPictureInPicture.requestWindow({
            width: 150,
            height: 150,
        });

        // Inject styles into the PiP window
        const style = pipWindow.document.createElement('style');
        style.textContent = `
            body, html { margin: 0; padding: 0; width: 100%; height: 100%; overflow: hidden; }
            #alert-box { width: 100vw; height: 100vh; background: #fff; transition: background 0.2s; }
            .trigger-active { background: #ff3b30 !important; }
        `;
        pipWindow.document.head.append(style);
        pipWindow.document.body.append(alertBox);

        // Move the box back to the main page when PiP is closed
        pipWindow.addEventListener("pagehide", () => {
            document.querySelector('.card').append(alertBox);
            pipWindow = null;
        });
    }

    function startAnalysis() {
        const v = document.createElement("video");
        v.srcObject = sourceStream;
        v.muted = true;
        v.play();

        setInterval(() => {
            if (v.readyState >= 2) {
                ctx.drawImage(v, 0, 0, canvas.width, canvas.height);
                const data = ctx.getImageData(0, 0, canvas.width, canvas.height).data;
                
                let total = 0, varSum = 0;
                const pixelCount = data.length / 4;

                // Calculate average brightness
                for (let i = 0; i < data.length; i += 4) {
                    total += (data[i] + data[i+1] + data[i+2]) / 3;
                }
                const avg = total / pixelCount;

                // Calculate Variance
                for (let i = 0; i < data.length; i += 4) {
                    const brightness = (data[i] + data[i+1] + data[i+2]) / 3;
                    varSum += Math.pow(brightness - avg, 2);
                }
                const currentVariance = varSum / pixelCount;

                // Update history and calculate Moving Average to prevent flickering
                varianceHistory.push(currentVariance);
                if (varianceHistory.length > MAX_HISTORY) varianceHistory.shift();
                
                const smoothedVariance = varianceHistory.reduce((a, b) => a + b) / varianceHistory.length;

                // Threshold logic (150)
                if (smoothedVariance > 150) {
                    alertBox.classList.add('trigger-active');
                    statusText.innerText = "Status: ACTIVE";
                } else {
                    alertBox.classList.remove('trigger-active');
                    statusText.innerText = "Status: CALM";
                }
            }
        }, 1000); // Check every second
    }
</script>

</body>
</html>
